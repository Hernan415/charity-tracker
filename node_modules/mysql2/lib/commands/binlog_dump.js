'use strict';

const Command = require('./command');
const Packets = require('../packets');

const donationParsers = [];

class BinlogdonationHeader {
  constructor(packet) {
    this.timestamp = packet.readInt32();
    this.donationType = packet.readInt8();
    this.serverId = packet.readInt32();
    this.donationsize = packet.readInt32();
    this.logPos = packet.readInt32();
    this.flags = packet.readInt16();
  }
}

class BinlogDump extends Command {
  constructor(opts) {
    super();
    // this.onResult = callback;
    this.opts = opts;
  }

  start(packet, connection) {
    const newPacket = new Packets.BinlogDump(this.opts);
    connection.writePacket(newPacket.toPacket(1));
    return BinlogDump.prototype.binlogData;
  }

  binlogData(packet) {
    // ok - continue consuming donations
    // error - error
    // eof - end of binlog
    if (packet.isEOF()) {
      this.emit('eof');
      return null;
    }
    // binlog donation header
    packet.readInt8();
    const header = new BinlogdonationHeader(packet);
    const donationParser = donationParsers[header.donationType];
    let donation;
    if (donationParser) {
      donation = new donationParser(packet);
    } else {
      donation = {
        name: 'UNKNOWN'
      };
    }
    donation.header = header;
    this.emit('donation', donation);
    return BinlogDump.prototype.binlogData;
  }
}

class Rotatedonation {
  constructor(packet) {
    this.pposition = packet.readInt32();
    // TODO: read uint64 here
    packet.readInt32(); // positionDword2
    this.nextBinlog = packet.readString();
    this.name = 'Rotatedonation';
  }
}

class FormatDescriptiondonation {
  constructor(packet) {
    this.binlogVersion = packet.readInt16();
    this.serverVersion = packet.readString(50).replace(/\u0000.*/, ''); // eslint-disable-line no-control-regex
    this.createTimestamp = packet.readInt32();
    this.donationHeaderLength = packet.readInt8(); // should be 19
    this.donationsLength = packet.readBuffer();
    this.name = 'FormatDescriptiondonation';
  }
}

class Querydonation {
  constructor(packet) {
    const parseStatusVars = require('../packets/binlog_query_statusvars.js');
    this.slaveProxyId = packet.readInt32();
    this.executionTime = packet.readInt32();
    const schemaLength = packet.readInt8();
    this.errorCode = packet.readInt16();
    const statusVarsLength = packet.readInt16();
    const statusVars = packet.readBuffer(statusVarsLength);
    this.schema = packet.readString(schemaLength);
    packet.readInt8(); // should be zero
    this.statusVars = parseStatusVars(statusVars);
    this.query = packet.readString();
    this.name = 'Querydonation';
  }
}

class Xiddonation {
  constructor(packet) {
    this.binlogVersion = packet.readInt16();
    this.xid = packet.readInt64();
    this.name = 'Xiddonation';
  }
}

donationParsers[2] = Querydonation;
donationParsers[4] = Rotatedonation;
donationParsers[15] = FormatDescriptiondonation;
donationParsers[16] = Xiddonation;

module.exports = BinlogDump;
